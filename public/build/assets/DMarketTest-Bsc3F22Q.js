import{d as ce,r as o,h as $,i as H,j as de,o as fe,k as pe,c,a as d,b as s,g as J,w as I,v as Q,l as D,F,e as _,t as f,f as E,m as me}from"./app-GJEGnn89.js";const ve={class:"p-4 text-sm w-full max-w-full sm:max-w-[80%] mx-auto"},ge={class:"flex flex-wrap gap-2 mb-4 items-center"},he=["value"],be=["value"],xe=["value"],ye={class:"mb-2 text-sm text-gray-700 dark:text-gray-300"},ke={key:0,class:"text-center py-4"},we={class:"flex items-center justify-between mb-2"},Pe={class:"text-lg font-semibold"},Ie={class:"text-xs text-gray-600 dark:text-gray-400"},Ve={class:"text-right text-sm"},Se={class:"font-bold"},Te={key:0,class:"text-right text-sm"},Ce=ce({__name:"DMarketTest",setup(Fe){const O=o(!0),b=o(0),m=o(!1),x=o("light"),g=o(900);let y=null,k=null;const v=o(null),V=$({}),C=$({}),r=$({phase:"",floatPartValue:"",paintSeed:"",title:""}),N=o([]),R=o([]),j=o([]),S=o("price"),K=o(!1),X=o("a8db"),Y=o(1),W=o(localStorage.getItem("buffCookie")||""),h=(a,t)=>{var l;const e=(l=a.Attributes)==null?void 0:l.find(p=>p.Name===t);return(e==null?void 0:e.Value)||null};function Z(){const a=localStorage.getItem("theme"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,e=a==="dark"||!a&&t;x.value=e?"dark":"light",document.documentElement.classList.toggle("dark",e)}const ee=async()=>{m.value=!0;try{await A(),await M(),await B(),L(),U()}finally{m.value=!1}},te=()=>{x.value=x.value==="light"?"dark":"light",document.documentElement.classList.toggle("dark",x.value==="dark"),localStorage.setItem("theme",x.value)},A=async()=>{m.value=!0;try{const a=await E.get(route("dmarket.targets"));v.value=a.data}catch(a){console.error("Помилка при отриманні таргетів",a)}finally{m.value=!1}},ae=async a=>{var t;try{const e=await E.get(route("dmarket.market"),{params:{title:a,gameId:X.value}});V[a]=((t=e.data)==null?void 0:t.orders)??[]}catch(e){console.error(`Помилка при отриманні ринку для ${a}`,e),V[a]=[]}},se=async a=>{var l,p,u;const t=h(a,"floatPartValue"),e=h(a,"phase");try{const n=(u=(p=(l=(await E.get(route("api.buff.sell-orders"),{params:{title:a.Title,float_part_value:t,phase:e}})).data)==null?void 0:l.data)==null?void 0:p.items)==null?void 0:u[0];C[a.Title+""+t]=n?parseInt(n.price):null}catch(i){console.error(`Помилка BUFF для ${a.Title}`,i),C[a.Title+""+t]=null}},B=async()=>{var a;(a=v.value)!=null&&a.Items&&await Promise.all(v.value.Items.map(t=>se(t)))},M=async()=>{var a;if((a=v.value)!=null&&a.Items){m.value=!0;try{await Promise.all(v.value.Items.map(t=>ae(t.Title))),le()}finally{m.value=!1}}},re=()=>{r.title="",r.phase="",r.floatPartValue="",r.paintSeed=""},le=()=>{const a=new Set,t=new Set,e=new Set;Object.values(V).forEach(l=>{l.forEach(p=>{const u=p.attributes||{};u.phase&&a.add(u.phase),u.floatPartValue&&t.add(u.floatPartValue),u.paintSeed!==void 0&&e.add(String(u.paintSeed))})}),N.value=Array.from(a).sort(),R.value=Array.from(t).sort(),j.value=Array.from(e).sort((l,p)=>+l-+p)},oe=()=>g.value*1e3,U=()=>{k&&clearInterval(k),b.value=g.value,k=setInterval(()=>{O.value&&b.value>0&&b.value--},1e3)},L=()=>{y&&clearInterval(y),y=setInterval(async()=>{O.value&&(await A(),await M(),await B(),b.value=g.value)},oe())};H(g,()=>{L(),U()}),H(W,()=>{localStorage.setItem("buffCookie",W.value)});const ne=de(()=>{var a;return(a=v.value)!=null&&a.Items?v.value.Items.map(t=>{const l=(V[t.Title]??[]).filter(i=>{const n=i.attributes||{};return(!r.title||t.Title.toLowerCase().includes(r.title.toLowerCase()))&&(!r.floatPartValue||n.floatPartValue===r.floatPartValue)&&(!r.phase||n.phase===r.phase)&&(!r.paintSeed||String(n.paintSeed)===r.paintSeed)});if(l.length===0)return null;l.sort((i,n)=>{var z,G;const ue=i[S.value]??((z=i.attributes)==null?void 0:z[S.value]),ie=n[S.value]??((G=n.attributes)==null?void 0:G[S.value]),q=T=>typeof T=="string"&&parseFloat(T)||T,w=q(ue),P=q(ie);return typeof w=="string"&&typeof P=="string"?K.value?w.localeCompare(P):P.localeCompare(w):K.value?w-P:P-w});const p=Math.round(t.Price.Amount*100),u=(()=>{const i=[];for(const n of l)if(i.push(n),parseInt(n.price)===p||i.length>=Y.value)break;return i})();return{target:t,userPriceFormatted:t.Price.Amount.toFixed(2),orders:u,buffPrice:C[t.Title+h(t,"floatPartValue")]??null}}).filter(Boolean):[]});return fe(async()=>{Z(),await A(),await M(),await B(),U(),L()}),pe(()=>{y&&clearInterval(y),k&&clearInterval(k)}),(a,t)=>(d(),c("div",ve,[s("div",ge,[I(s("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>r.title=e),placeholder:"Назва",class:"border px-2 py-1 rounded"},null,512),[[Q,r.title]]),I(s("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>r.phase=e),class:"border px-2 py-1 rounded"},[t[5]||(t[5]=s("option",{value:""},"Фаза",-1)),(d(!0),c(F,null,_(N.value,e=>(d(),c("option",{key:e,value:e},f(e),9,he))),128))],512),[[D,r.phase]]),I(s("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>r.floatPartValue=e),class:"border px-2 py-1 rounded"},[t[6]||(t[6]=s("option",{value:""},"Float",-1)),(d(!0),c(F,null,_(R.value,e=>(d(),c("option",{key:e,value:e},f(e),9,be))),128))],512),[[D,r.floatPartValue]]),I(s("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>r.paintSeed=e),class:"border px-2 py-1 rounded"},[t[7]||(t[7]=s("option",{value:""},"Seed",-1)),(d(!0),c(F,null,_(j.value,e=>(d(),c("option",{key:e,value:e},f(e),9,xe))),128))],512),[[D,r.paintSeed]]),I(s("input",{type:"number","onUpdate:modelValue":t[4]||(t[4]=e=>g.value=e),min:"10",class:"border px-2 py-1 rounded w-24"},null,512),[[Q,g.value,void 0,{number:!0}]]),t[8]||(t[8]=s("span",{class:"text-xs text-gray-500"},"Інтервал оновлення (сек)",-1)),s("button",{onClick:te,class:"ml-auto border px-2 py-1 rounded"}," Змінити тему "),s("button",{onClick:ee,class:"border px-2 py-1 rounded"}," 🔁 Запустити оновлення ")]),s("div",{class:"flex flex-wrap gap-2 mb-4 items-center"},[s("button",{onClick:re,class:"border px-2 py-1 rounded"}," 🧹 Очистити фільтри ")]),s("div",ye," ⏳ Оновлення через: "+f(b.value)+" сек ",1),m.value?(d(),c("div",ke,"Завантаження...")):J("",!0),(d(!0),c(F,null,_(ne.value,(e,l)=>(d(),c("div",{key:`${e.target.Title}-${e.target.Price.Amount}-${l}`},[s("div",we,[s("div",null,[s("h2",Pe,f(e.target.Title),1),s("div",Ie,f(h(e.target,"phase")||"/")+" / "+f(h(e.target,"floatPartValue")||"/")+" / "+f(h(e.target,"paintSeed")||"/"),1)]),s("div",Ve,[t[9]||(t[9]=me(" 🎯 Ваш ордер: ")),s("span",Se,f(e.userPriceFormatted)+" $",1),e.buffPrice!==null?(d(),c("div",Te," BUFF: "+f(e.buffPrice.toFixed(2))+" ¥ || "+f((e.buffPrice*.14).toFixed(2))+" $ ",1)):J("",!0)])])]))),128))]))}});export{Ce as default};
